---
# ============================================================================
# Nightscout Modern - Docker Compose
# ============================================================================
# Author: Diego Castilho
# Description: Modern interface for Nightscout CGM monitoring
# Stack: React + TypeScript + Vite + Node.js + Express + MongoDB
#
# SETUP:
#   1. cp .env.example .env
#   2. Edit .env with your values
#   3. docker compose up -d
#
# NETWORKING:
#   - Default: bridge network + port binding (community-friendly)
#   - Advanced (MacVLAN): see docker-compose.macvlan.yml
#     Usage: docker compose -f docker-compose.yml -f docker-compose.macvlan.yml up -d
# ============================================================================

services:
  # ==========================================================================
  # BACKEND API
  # ==========================================================================
  nightscout-modern-backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: nightscout-modern-backend
    hostname: nightscout-modern-backend
    restart: unless-stopped

    labels:
      - "com.docker.compose.project=nightscout-modern"
      - "service.group=health"
      - "service.type=api"
      - "service.description=Nightscout Modern Backend API"

    networks:
      - nightscout_internal

    environment:
      NODE_ENV: production
      PORT: 3001
      TZ: ${TZ:-America/Sao_Paulo}

      # MongoDB — configure in .env
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-nightscout}
      MONGODB_USER: ${MONGODB_USER:-}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-}

      # Security — configure in .env
      API_SECRET: ${NIGHTSCOUT_API_SECRET}
      JWT_SECRET: ${NIGHTSCOUT_MODERN_JWT_SECRET}
      JWT_EXPIRES_IN: 7d

      # CORS — configure in .env (comma-separated list of allowed origins)
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}

      # LibreLink MCP Integration (optional)
      LIBRELINK_USERNAME: ${LIBRELINK_USERNAME:-}
      LIBRELINK_PASSWORD: ${LIBRELINK_PASSWORD:-}
      LIBRELINK_REGION: ${LIBRELINK_REGION:-LA}

      # Logs
      LOG_LEVEL: ${LOG_LEVEL:-info}

    deploy:
      resources:
        limits:
          memory: 2048M
          cpus: '0.5'

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # FRONTEND WEB APP
  # ==========================================================================
  nightscout-modern-frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    container_name: nightscout-modern-frontend
    hostname: nightscout-modern-frontend
    restart: unless-stopped

    labels:
      - "com.docker.compose.project=nightscout-modern"
      - "service.group=health"
      - "service.type=web"
      - "service.description=Nightscout Modern Frontend"

    # Default: expose via port binding.
    # For MacVLAN with static IP, use docker-compose.macvlan.yml override.
    ports:
      - "${FRONTEND_PORT:-80}:80"

    networks:
      - nightscout_internal

    depends_on:
      nightscout-modern-backend:
        condition: service_healthy

    environment:
      TZ: ${TZ:-America/Sao_Paulo}

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.25'

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  # Internal bridge network for service-to-service communication.
  # Docker DNS resolves service names (e.g. nightscout-modern-backend).
  nightscout_internal:
    driver: bridge
